# Cromwell on GCP

## Overview
The Cromwell-on-GCP installer uses [Terraform](TERRAFORM.md) to create an installation of Cromwell using Google Compute Engine,
Google Cloud Run, Google Cloud SQL, and the Google Pipelines API, in either a
[single project](https://docs.google.com/drawings/d/1tQjsM_d-yATFdmUlJ4X0Vk2xj9l9j95Kc6yO4T37vMo/edit) or
[multi-project](https://docs.google.com/drawings/d/1c2O3LqCgWtZWzsnpP8UOJGI7WFLN9YYd6WJWVNpf6tk/edit) architecture.

A Cloud Run service is used as the ingress for all requests to Cromwell, and calling this service requires a
GCP identity token of a principal (user or service account) that has been granted permission to call that service.

### Resource Layout
The following represents the layout of resources. Italicized GCP projects indicate these can be pre-existing
projects not generated by this script.

* Deployment GCP Project
    * Compute VM (with running Cromwell deployment)
    * Service Account for Cromwell
    * Cloud SQL Instance (MySQL)
    * GCS bucket (for Cromwell output)
    * Cloud Run service (with Nginx reverse proxy to Cromwell)
    * VPC and Cloud NAT (networks for Cromwell, Database, etc.)
* _Billing GCP Project_ (for GCS bucket billing)
* _Compute GCP Project_
    * VPC and Cloud NAT (used by pipeline tasks)
    * Service Account for pipeline tasks

### Enabled APIs
This script enables all APIs required for running and configuring Cromwell, including Compute, Networking,
and Lifesciences Pipelines. When a pre-existing compute project is used, required APIs will be enabled in this project
but they _will not_ be disabled if you run `terraform destroy`.

## Prerequisites
To run this script, you must have the following prepared:
1. Pick an existing GCP Billing Account ID

   The given ID will be set as the billing account for the generated GCP project. To find or create billing accounts
   go to the [billing account page](https://console.cloud.google.com/billing) in the Google Cloud Console.
2. Pick a new GCP project ID and name

   These are the ID and name for the generated project. You can set them to whatever valid values you wish, but the
   project ID must be globally unique.
3. Install the `gcloud` and `terraform` command-line tools.
4. (Optional) Pick an existing GCP Project Folder ID

   When provided, the GCP project containing the Cromwell deployment will be generated in the given folder ID. To find
   or create a folder, go to the [cloud resource manager](https://console.cloud.google.com/cloud-resource-manager)
   in the Google Cloud Console.
5. _Optional_: Install [jq](https://stedolan.github.io/jq/) &mdash; this is used in documented commands for testing
   your installation, and is not required for installing the engine.

## Apply Configuration with Single Project
1. Set the `gcp` directory that contains this README as your working directory:

    ```bash
    cd gcp
    ```
2. Authorize you application-default credentials:

    ```bash
    gcloud auth application-default login
    ```
3. Create file with variable assignments for your installation, `cromwell.tfvars`, replacing `$FOLDER_ID`,
   `$BILLING_ACCOUNT`, `$PROJECT_ID`, and `$PROJECT_NAME` with literal values:

    ```terraform
    deployment_project_id              = "$PROJECT_ID"
    deployment_project_name            = "$PROJECT_NAME"
    deployment_project_billing_account = "$BILLING_ACCOUNT"
    # Delete the line below to create a project without a project folder
    deployment_project_folder_id       = "$FOLDER_ID"
    ```
4. Apply the configuration with your variable assignments:

    ```bash
    terraform apply -var-file=cromwell.tfvars
    ```

   Terraform will print out a plan and ask you to type `yes` before starting. If you are running this for the first
   time, the plan should only add resources (no changes or removals). _Make sure the plan only adds resources
   before accepting!_

## Apply Configuration with Multiple Projects
Follow the steps to set up with a single project, but in addition to the variables mentioned above you must also
add these variables to your `cromwell.tfvars` file:

```terraform
compute_project_id = "$COMPUTE_PROJECT_ID"
billing_project_id = "$BILLING_PROJECT_ID"
```

When either of these variables are unassigned, they default to using the `deployment_project_id` project that is
always generated as part of applying the configuraiton.

## Destroying Configuration
1. Before you can destroy resources, you must update stateful resources so that they can be destroyed:

    ```bash
    terraform apply -var-file=cromwell.tfvars -var=allow_deletion=true
    ```
2. Once the above step succeeds, you can destroy the configured resources. **Important**: this deletes the entire
   deployment project. It does not delete the compute or billing projects, and will not disable any APIs that were enabled
   in those projects. Run:

    ```bash
    terraform destroy -var-file=cromwell.tfvars -var=allow_deletion=true
    ```

## Using the Cromwell Installation
### Getting Deployment Information
Run `terraform output` to show information on the installation. This output will include:
* The URL, name, and location of the Cloud Run service used as an ingress for your Cromwell installation
* The email of a service account that can be used by external services to send requests to Cromwell

### Sending Requests to Cromwell with Developer Credentials
To send a request to the ingress service with your own identity token, run the following:
```bash
curl --request GET \
  --url "$(terraform output -json service | jq -r '.urls[0]')/api/ga4gh/wes/v1/service-info" \
  --header "Authorization: Bearer $(gcloud auth print-identity-token)"
```

If you receive a 403 response, you may need to grant yourself permission to call the Cloud Run service:
```bash
gcloud run services add-iam-policy-binding "$(terraform output -json service | jq -r '.name')" \
  --member="user:$(gcloud config get account)" \
  --role='roles/run.invoker' \
  --region="$(terraform output -json service | jq -r '.location')" \
  --project="$(terraform output -json service | jq -r '.project')"
```

### Authenticating with a Service Account
To allow an external service to access Cromwell, you must give it a service account with the appropriate permissions,
and a service account key to authenticate. Run `terraform output -raw generated_service_account_email` to get the email
of a service account with the correct permissions already generated by the Terraform configuration.

You can [generate keys](https://cloud.google.com/iam/docs/keys-create-delete#creating) for this service account using
`gcloud` or the Google Cloud Console.

If you need to create additional service accounts, the only required setup is granting them the `roles/run.invoker`
role on the Cloud Run service.
